<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Quiz de nomenclature</title>
  <style>
       body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 10px;
      line-height: 1.5;
    }
    #desc {
      background: #f7f7f7;
      padding: 10px;
      border-radius: 4px;
      font-size: 1.4rem;
      text-align: center;
      font-family: monospace;
    }
    input { width: 100%; padding: 6px; font-size: 1rem; box-sizing: border-box; }
    button { margin-top: 8px; padding: 6px 12px; font-size: 1rem; }
    #answer { margin-top: 12px; font-weight: bold; }
    canvas { display: block; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>Quiz de nomenclature</h1>
  <div id="desc"></div>
  <canvas id="struct" width="800" height="400"></canvas>
  <input id="guess" type="text" placeholder="Nom de la molécule" />
  <div>
    <button id="home" type="button">Accueil</button>
    <button id="check" type="button">Vérifier</button>
    <button id="reveal" type="button">Voir la solution</button>
    <button id="next" type="button">Nouvelle molécule</button>
  </div>
  <div id="answer"></div>
  <div id="score"></div>

  <script src="nomenclature.js"></script>
  <script>
    const descEl = document.getElementById('desc');
    const answerEl = document.getElementById('answer');
    const guessEl = document.getElementById('guess');
    const scoreEl = document.getElementById('score');
    const structCanvas = document.getElementById('struct');
    const dpr = window.devicePixelRatio || 1;
    const displayWidth = 800;
    const displayHeight = 400;
    structCanvas.width = displayWidth * dpr;
    structCanvas.height = displayHeight * dpr;
    structCanvas.style.width = displayWidth + 'px';
    structCanvas.style.height = displayHeight + 'px';
    const structCtx = structCanvas.getContext('2d');
    structCtx.scale(dpr, dpr);
    structCtx.lineWidth = 2;
    structCtx.lineCap = 'round';
    structCtx.lineJoin = 'round';
    structCtx.font = '16px sans-serif';
    let current;
    let score = 0;
    let total = 0;
    const SUB_DATA = Object.fromEntries(SUBSTITUANTS.map((s) => [s.name, s]));

    function formatFormula(str) {
      return str.replace(/(\d+)/g, '<sub>$1</sub>');
    }

    function normalizeName(str) {
      return str
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '');
    }

    function updateScore() {
      const pct = total ? Math.round((score / total) * 100) : 0;
      scoreEl.textContent = `Score : ${score}/${total} (${pct}%)`;
    }

    function nouvelleQuestion() {
      current = generateMolecule();
      descEl.innerHTML = formatFormula(current.description.formule);
      drawMolecule(current.struct);
      answerEl.textContent = '';
      guessEl.value = '';
      guessEl.focus();
    }
    function verifier() {
      const guess = normalizeName(guessEl.value);
      const correct = normalizeName(current.nom);
      total++;
      if (guess && guess === correct) {
        score++;
        answerEl.textContent = 'Correct !';
      } else {
        answerEl.textContent = 'Incorrect. Nom correct : ' + current.nom;
      }
      updateScore();
    }

    
    document.getElementById('reveal').addEventListener('click', () => {
      answerEl.textContent = 'Nom correct : ' + current.nom;
    });

        document.getElementById('check').addEventListener('click', verifier);
    guessEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') verifier();
    });

    document.getElementById('next').addEventListener('click', nouvelleQuestion);

        document.getElementById('home').addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    nouvelleQuestion();
    updateScore();
    
    function drawBond(a, b, order) {
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const len = Math.hypot(dx, dy);
      const offsetX = (-dy / len) * 3;
      const offsetY = (dx / len) * 3;
      structCtx.beginPath();
      if (order === 1) {
        structCtx.moveTo(a.x, a.y);
        structCtx.lineTo(b.x, b.y);
      } else if (order === 2) {
        structCtx.moveTo(a.x + offsetX, a.y + offsetY);
        structCtx.lineTo(b.x + offsetX, b.y + offsetY);
        structCtx.moveTo(a.x - offsetX, a.y - offsetY);
        structCtx.lineTo(b.x - offsetX, b.y - offsetY);
      } else if (order === 3) {
        structCtx.moveTo(a.x + 2 * offsetX, a.y + 2 * offsetY);
        structCtx.lineTo(b.x + 2 * offsetX, b.y + 2 * offsetY);
        structCtx.moveTo(a.x, a.y);
        structCtx.lineTo(b.x, b.y);
        structCtx.moveTo(a.x - 2 * offsetX, a.y - 2 * offsetY);
        structCtx.lineTo(b.x - 2 * offsetX, b.y - 2 * offsetY);
      }
      structCtx.stroke();
    }

    function drawBranch(label, c, dir, order = 1) {
      const length = 35;
      const end = { x: c.x, y: c.y + dir * length };
      drawBond(c, end, order);
      const textWidth = structCtx.measureText(label).width;
      structCtx.fillText(label, end.x - textWidth / 2, end.y + (dir < 0 ? -6 : 16));
    }

      function drawLinearSub(len, c, dir) {
      const step = 25;
      const zig = 10;
      let prev = { x: c.x, y: c.y + dir * step };
      drawBond(c, prev, 1);
      for (let i = 1; i < len; i++) {
        const next = { x: prev.x + (i % 2 ? -zig : zig), y: prev.y + dir * step };
        drawBond(prev, next, 1);
        prev = next;
      }
      const label = 'CH3';
      const w = structCtx.measureText(label).width;
      structCtx.fillText(label, prev.x - w / 2, prev.y + (dir > 0 ? 16 : -6));
    }

    function drawIsoPropyl(c, dir) {
      const step = 25;
      const base = { x: c.x, y: c.y + dir * step };
      drawBond(c, base, 1);
      const left = { x: base.x - 10, y: base.y + dir * step };
      const right = { x: base.x + 10, y: base.y + dir * step };
      drawBond(base, left, 1);
      drawBond(base, right, 1);
      const label = 'CH3';
      const w = structCtx.measureText(label).width;
      structCtx.fillText(label, left.x - w / 2, left.y + (dir > 0 ? 16 : -6));
      structCtx.fillText(label, right.x - w / 2, right.y + (dir > 0 ? 16 : -6));
    }

    function drawIsoButyl(c, dir) {
      const step = 25;
      const first = { x: c.x, y: c.y + dir * step };
      drawBond(c, first, 1);
      const second = { x: first.x, y: first.y + dir * step };
      drawBond(first, second, 1);
      const left = { x: second.x - 10, y: second.y + dir * step };
      const right = { x: second.x + 10, y: second.y + dir * step };
      drawBond(second, left, 1);
      drawBond(second, right, 1);
      const label = 'CH3';
      const w = structCtx.measureText(label).width;
      structCtx.fillText(label, left.x - w / 2, left.y + (dir > 0 ? 16 : -6));
      structCtx.fillText(label, right.x - w / 2, right.y + (dir > 0 ? 16 : -6));
    }

    function drawSecButyl(c, dir) {
      const step = 25;
      const base = { x: c.x, y: c.y + dir * step };
      drawBond(c, base, 1);
      const branch = { x: base.x - 10, y: base.y + dir * step };
      drawBond(base, branch, 1);
      const label = 'CH3';
      let w = structCtx.measureText(label).width;
      structCtx.fillText(label, branch.x - w / 2, branch.y + (dir > 0 ? 16 : -6));
      const second = { x: base.x, y: base.y + dir * step };
      drawBond(base, second, 1);
      const third = { x: second.x + 10, y: second.y + dir * step };
      drawBond(second, third, 1);
      w = structCtx.measureText(label).width;
      structCtx.fillText(label, third.x - w / 2, third.y + (dir > 0 ? 16 : -6));
    }

    function drawTertButyl(c, dir) {
      const step = 25;
      const center = { x: c.x, y: c.y + dir * step };
      drawBond(c, center, 1);
      const up = { x: center.x, y: center.y + dir * step };
      const left = { x: center.x - 15, y: center.y + dir * step };
      const right = { x: center.x + 15, y: center.y + dir * step };
      drawBond(center, up, 1);
      drawBond(center, left, 1);
      drawBond(center, right, 1);
      const label = 'CH3';
      const w = structCtx.measureText(label).width;
      structCtx.fillText(label, up.x - w / 2, up.y + (dir > 0 ? 16 : -6));
      structCtx.fillText(label, left.x - w / 2, left.y + (dir > 0 ? 16 : -6));
      structCtx.fillText(label, right.x - w / 2, right.y + (dir > 0 ? 16 : -6));
    }

    function drawSubstituent(name, c, dir) {
      if (name === 'isopropyl') return drawIsoPropyl(c, dir);
      if (name === 'isobutyl') return drawIsoButyl(c, dir);
      if (name === 'sec-butyl') return drawSecButyl(c, dir);
      if (name === 'tert-butyl') return drawTertButyl(c, dir);
      const data = SUB_DATA[name];
      if (data) {
        drawLinearSub(data.len, c, dir);
      } else {
        drawBranch(SUB_FORMULES[name] || name, c, dir);
      }
    }


    function drawMolecule(data) {
    structCtx.clearRect(0, 0, displayWidth, displayHeight);
      const { n, subs, halos, groupe, positionsFG } = data;
      const step = 60;
      const baseY = displayHeight / 2;
      const zig = 20;
      const coords = [];
      const startX = (displayWidth - (n - 1) * step) / 2;
      for (let i = 0; i < n; i++) {
        const x = startX + i * step;
        const y = baseY + (i % 2 === 0 ? -zig : zig);
        coords.push({ x, y });
        if (i > 0) {
          let order = 1;
          if (groupe === 'alcène' && positionsFG[0] === i) order = 2;
          if (groupe === 'alcyne' && positionsFG[0] === i) order = 3;
          drawBond(coords[i - 1], coords[i], order);
        }
      }

      subs.forEach((s) => {
        const c = coords[s.position - 1];
        const dir = s.position % 2 === 0 ? 1 : -1;
        drawSubstituent(s.sub, c, dir);
      });

      halos.forEach((h) => {
        const c = coords[h.position - 1];
        const dir = h.position % 2 === 0 ? -1 : 1;
        drawBranch(HALO_SYMBOLS[h.name], c, dir);
      });

      if (groupe === 'alcool') {
        positionsFG.forEach((p) => {
          const c = coords[p - 1];
          const dir = p % 2 === 0 ? -1 : 1;
          drawBranch('OH', c, dir);
        });
      } else if (groupe === 'cétone') {
        positionsFG.forEach((p) => {
          const c = coords[p - 1];
          const dir = p % 2 === 0 ? -1 : 1;
          drawBranch('O', c, dir, 2);
        });
      } else if (groupe === 'aldéhyde') {
        const c = coords[0];
        drawBranch('O', c, -1, 2);
        drawBranch('H', c, 1);
      }
    }
  </script>
</body>
</html>
