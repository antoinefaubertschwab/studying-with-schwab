<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Étude — Hub (Flashcards)</title>
  <meta name="description" content="Flashcards de groupements fonctionnels en chimie organique. Mode entraînement, indice, temps par carte, meilleur score. Parfait pour Cégep et pré-med." />
  <meta name="keywords" content="flashcards, chimie organique, groupements fonctionnels, cégep, médecine, étude, quiz" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://exemple.com/" />

  <!-- Social / Open Graph -->
  <meta property="og:title" content="Étude — Hub (Flashcards Chimie Org)" />
  <meta property="og:description" content="Révise 18 groupements fonctionnels avec dessins clairs, timer et meilleur score." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://exemple.com/" />
  <meta property="og:image" content="/og-image.png" />
  <meta property="og:locale" content="fr_CA" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Étude — Hub (Flashcards Chimie Org)" />
  <meta name="twitter:description" content="Révise 18 groupements fonctionnels avec dessins clairs, timer et meilleur score." />
  <meta name="twitter:image" content="/og-image.png" />

  <!-- PWA / Icons -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- JSON-LD (WebApplication) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Étude — Hub",
    "url": "https://exemple.com/",
    "applicationCategory": "EducationalApplication",
    "about": "Flashcards de groupements fonctionnels (chimie organique)",
    "inLanguage": "fr-CA",
    "operatingSystem": "Web",
    "offers": { "@type": "Offer", "price": "0" }
  }
  </script>

  <style>
    :root{--bg:#ffffff;--surface:#ffffff;--card:#ffffff;--ink:#111111;--muted:#6b7280;--border:#e5e7eb;--brand:#8b5cf6}
    .dark{--bg:#0f172a;--surface:#1e293b;--card:#1f2937;--ink:#f1f5f9;--muted:#94a3b8;--border:#334155;--brand:#8b5cf6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    [hidden]{display:none !important}
    .shell{max-width:1200px;margin:0 auto;padding:24px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#f4f5f7,#eaeefb);border:1px solid #e5e7eb}
    .dark .logo{background:linear-gradient(135deg,#182033,#111827);border-color:#334155}
    .logo svg{opacity:.9}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin:0}
    .apps{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:10px}
    .app{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;gap:14px;align-items:center;cursor:pointer;transition:.2s transform,.2s border-color,.2s box-shadow}
    .app:hover{transform:translateY(-2px);border-color:#d1d5db;box-shadow:0 6px 24px rgba(17,24,39,.08)}
    .dark .app:hover{border-color:#3b4252;box-shadow:0 6px 24px rgba(0,0,0,.3)}
    .app:active{transform:translateY(0)}
    .app .icon{width:54px;height:54px;border-radius:12px;background:radial-gradient(65% 65% at 35% 35%, #eef2ff, #e5e7eb);display:grid;place-items:center;border:1px solid #e5e7eb}
    .dark .app .icon{background:radial-gradient(65% 65% at 35% 35%, #1f2937, #0f172a);border-color:#334155}
    .app .meta{min-width:0}
    .app .meta .title{font-weight:700;letter-spacing:.2px}
    .app .meta .desc{color:var(--muted);font-size:13px;margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--ink);font-size:12px}
    .row{display:flex;align-items:center;gap:12px;margin:12px 0;flex-wrap:wrap}
    .btn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.alt{background:var(--surface);color:var(--ink)}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 18px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:minmax(0,1fr) auto;gap:12px}
    input[type=text]{width:100%;background:var(--card);color:var(--ink);border:1px solid var(--border);border-radius:14px;padding:12px 14px;outline:none}
    input[type=text]:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.25)}
    .hint{color:var(--muted);font-size:12px}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .bad{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .msg{margin-top:10px;border-radius:12px;padding:10px 12px;font-weight:600}
    svg{width:100%;height:auto;display:block}
    .svgwrap{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .answer{color:var(--ink)}
    .footer{margin-top:18px;color:#64748b;font-size:12px}
    .back{display:flex;align-items:center;gap:8px}
    .back svg{opacity:.85}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}
    :focus-visible{outline:3px solid #8b5cf6;outline-offset:2px}
    #zoom{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
    #zoomInner{background:#fff;border-radius:12px;max-width:960px;width:100%;padding:16px}
    #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:60}
    #palette{display:flex;gap:8px}
    .atom{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;background:var(--card);border:1px solid var(--border);cursor:grab}
    .atom.selected{outline:2px solid var(--brand);}
    #trash{cursor:default;color:var(--muted)}
    #trash.over{background:#fee2e2;border-color:#fca5a5;color:#991b1b}
    #workspace{position:relative;overflow:hidden}
    #bond-tools .btn{padding:6px 10px}
    #bond-tools .btn.active{background:var(--brand);color:#fff}
    .match-wrap{position:relative;display:flex;justify-content:center;gap:320px;align-items:flex-start;min-height:80vh}
    .match-col{display:flex;flex-direction:column;gap:16px;font-size:14px}
    .match-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:2px 6px;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:center;height:80px;position:relative}
    .match-item img{height:72px;width:auto;display:block}
    .match-col{display:flex;flex-direction:column;gap:16px;font-size:14px}
    .match-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:2px 6px;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:center;height:80px}
    .match-item img{height:72px;width:auto;display:block}
    .match-item.selected{outline:2px solid var(--brand)}
    .match-lines{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
    .match-dot{position:absolute;width:12px;height:12px;border-radius:50%;background:var(--ink);top:50%;transform:translateY(-50%)}
    .match-item[data-side="left"] .match-dot{right:-24px}
    .match-item[data-side="right"] .match-dot{left:-24px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="9" stroke="#8b5cf6"/>
            <path d="M12 3 L20 12 L12 21 L4 12 Z" stroke="#8b5cf6" opacity=".35"/>
          </svg>
        </div>
        <div>
          <h1>Étude — Hub</h1>
          <p class="sub">Choisis un module pour commencer</p>
        </div>
      </div>
      <div class="row" style="margin:0">
        <div class="pill" id="breadcrumbs">Accueil</div>
        <button id="theme-toggle" class="btn ghost" type="button">Thème</button>
      </div>
    </div>

    <section id="home">
         <div class="apps">
        <button class="app" id="open-chimie" type="button">
          <div class="icon">
            <svg width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 4h6l2 2h10v12H3z" fill="none" stroke="currentColor"/>
            </svg>
          </div>
          <div class="meta">
            <div class="title">Chimie organique</div>
            <div class="desc">Modules et exercices</div>
          </div>
        </button>
      </div>
    </section>

    <section id="chimie" hidden>
      <div class="bar">
        <button class="btn ghost back" id="back-home-chimie" type="button" aria-label="Retour à l'accueil">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Accueil
        </button>
        <div class="pill">Chimie organique</div>
      </div>
      <div class="apps">
        <button class="app" id="open-pratique" type="button">
          <div class="icon">
            <svg width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 5h8l2 2h6v10H4z" fill="none" stroke="currentColor"/>
            </svg>
          </div>
          <div class="meta">
            <div class="title">Pratique des groupes fonctionnels</div>
            <div class="desc">3 modes interactifs</div>
          </div>
        </button>
      </div>
    </section>

    <section id="fg-hub" hidden>
      <div class="bar">
        <button class="btn ghost back" id="back-chimie" type="button" aria-label="Retour à la chimie organique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Chimie org
        </button>
        <div class="pill">Pratique des groupes fonctionnels</div>
      </div>
      <div class="apps">
        <button class="app" id="open-gf" type="button">
          <div class="icon">
            <svg width="36" height="36" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
              <polygon points="60,18 92,36 92,72 60,90 28,72 28,36" fill="none" stroke="currentColor" stroke-width="3"/>
              <circle cx="60" cy="54" r="18" fill="none" stroke="currentColor" stroke-width="3"/>
            </svg>
          </div>
          <div class="meta">
            <div class="title">Flashcards — Groupements fonctionnels</div>
            <div class="desc">18 cartes · réponse courte · dessins nets</div>
          </div>
          <span class="pill" id="best-pill" style="margin-left:auto">Meilleur : 0/18</span>
        </button>
        <button class="app" id="open-inverse" type="button">
          <div class="icon">
            <svg width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor"/>
              <path d="M12 6 V18 M6 12 H18" stroke="currentColor"/>
            </svg>
          </div>
          <div class="meta">
            <div class="title">Mode inverse — Construire</div>
            <div class="desc">Glisse atomes et liaisons pour former le groupe</div>
          </div>
        </button>
        <button class="app" id="open-match" type="button">
          <div class="icon">
            <svg width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
             <circle cx="7" cy="12" r="3" fill="none" stroke="currentColor"/>
              <circle cx="17" cy="12" r="3" fill="none" stroke="currentColor"/>
              <path d="M10 12 H14" stroke="currentColor"/>
            </svg>
          </div>
          <div class="meta">
                <div class="title">Match — Relier</div>
            <div class="desc">Associe noms et structures</div>
          </div>
        </button>
      </div>
    </section>

    <section id="gf" hidden>
      <div class="bar">
              <button class="btn ghost back" id="back-home" type="button" aria-label="Retour à la pratique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
         Pratique
        </button>
        <div class="pill">Flashcards GF</div>
        <button class="btn ghost" id="gf-help" type="button">Aide</button>
      </div>

      <h2 style="margin:0 0 6px 0;font-size:20px">Flashcards inverses — Groupements fonctionnels (18)</h2>
      <p class="sub" style="margin-bottom:12px">Tape le nom du groupe (FR/EN, accents ignorés). Mélange, réponds, révèle si nécessaire.</p>

      <div class="row">
        <button class="btn" id="shuffle" type="button">Mélanger</button>
        <button class="btn alt" id="time-btn" type="button">Temps/carte : 8s</button>
        <button class="btn alt" id="hint" type="button">Indice</button>
        <span class="pill" id="timer">00:08</span>
        <span class="pill" id="prog"></span>
        <span class="pill" id="score"></span>
      </div>

      <div class="card svgwrap" id="svgwrap"><div id="svg"></div></div>

      <div class="row grid">
        <input type="text" id="input" placeholder="Ex. alcool, cétone, nitrile…" />
        <div style="display:flex;gap:10px">
          <button class="btn" id="check" type="button">Vérifier</button>
          <button class="btn alt" id="reveal" type="button">Révéler</button>
          <button class="btn" id="next" type="button">Suivant</button>
        </div>
      </div>

      <p class="sub" style="margin-top:6px">Raccourcis : Enter=Vérifier · R=Révéler · N=Suivant · M=Mélanger</p>

      <div id="msg"></div>
      <div id="live" aria-live="polite" class="visually-hidden"></div>
      <div class="footer" id="accepted"></div>

      <div class="row" id="finish-actions" hidden>
        <button class="btn" id="restart" type="button">Recommencer le quiz</button>
      </div>
    </section>
    <section id="builder" hidden>
      <div class="bar">
          <button class="btn ghost back" id="back-home-builder" type="button" aria-label="Retour à la pratique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Pratique
        </button>
        <div class="pill">Mode inverse</div>
        <div class="pill" id="inv-prog">0/18</div>
        <div class="pill" id="inv-score">Score : 0</div>
        <button class="btn ghost" id="builder-help" type="button">Aide</button>
      </div>

      <h2 style="margin:0 0 6px 0;font-size:20px">Construis : <span id="inv-target"></span></h2>
      <p class="sub" style="margin-bottom:12px">Glisse les atomes et choisis la liaison.</p>

      <div id="bond-tools" class="row">
        <span class="pill">Liaison :</span>
        <button class="btn" data-bond="1" type="button">-</button>
        <button class="btn" data-bond="2" type="button">=</button>
        <button class="btn" data-bond="3" type="button">≡</button>
      </div>

      <div id="palette" class="row">
        <div class="atom" data-atom="C">C</div>
        <div class="atom" data-atom="O">O</div>
        <div class="atom" data-atom="N">N</div>
        <div class="atom" data-atom="H">H</div>
        <div class="atom" data-atom="R">R</div>
        <div class="atom" data-atom="R'">R'</div>
      </div>

      <div id="workspace" class="card" style="height:400px"><svg id="bonds" style="position:absolute;top:0;left:0;pointer-events:none;width:100%;height:100%"></svg></div>

      <div class="row" style="margin-top:12px">
        <div id="trash" class="atom" aria-label="Supprimer">🗑️</div>
        <button class="btn ghost" id="clear-all" type="button">Tout effacer</button>
        <button class="btn" id="show-answer" type="button">Voir la solution</button>
      </div>
      <div id="answer-box" class="svgwrap" hidden></div>
      <div class="row" id="self-eval" hidden>
        <button class="btn ok" id="self-right" type="button">J'avais raison</button
        ><button class="btn bad" id="self-wrong" type="button">Je me suis trompé</button>
      </div>
      <div id="inv-msg"></div>
      <div class="row" id="inv-finish" hidden>
        <button class="btn" id="inv-restart" type="button">Recommencer le quiz</button>
      </div>
    </section>
       <section id="match" hidden>
      <div class="bar">
        <button class="btn ghost back" id="back-match" type="button" aria-label="Retour à la pratique">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Pratique
        </button>
        <div class="pill">Match GF</div>
        <div class="pill" id="match-timer">0s</div>
        <button class="btn ghost" id="match-help" type="button">Aide</button>
      </div>
      <h2 style="margin:0 0 6px 0;font-size:20px">Associe chaque structure à son nom</h2>
      <p class="sub" style="margin-bottom:12px">Clique une structure puis un nom pour créer un lien.</p>
      <div id="match-area" class="match-wrap">
        <div id="match-left" class="match-col"></div>
        <svg id="match-lines" class="match-lines"></svg>
        <div id="match-right" class="match-col"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="match-check" type="button">Vérifier</button>
        <button class="btn alt" id="match-hint" type="button">Indice</button>
        <button class="btn ghost" id="match-restart" type="button">Recommencer</button>
      </div>
      <div id="match-msg"></div>
    </section>
  </div>

  <div id="zoom"><div id="zoomInner"></div></div>
  <div id="toast"></div>

  <script>
    (function(){
      // --- Thème clair/sombre ---
      const THEME_KEY = 'theme';
      const applyTheme = (t) => document.body.classList.toggle('dark', t === 'dark');
      const savedTheme = localStorage.getItem(THEME_KEY);
      if (savedTheme) {
        applyTheme(savedTheme);
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        applyTheme('dark');
      }
      document.getElementById('theme-toggle').addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
      });

      // --- Utils / dessin ---
      const norm = (s) => {
        let t = s.toLowerCase().normalize('NFD');
        let out = '';
        for (let i = 0; i < t.length; i++) {
          const code = t.charCodeAt(i);
          if (code >= 0x0300 && code <= 0x036F) continue;
          out += t[i];
        }
        out = out.replace(/’/g,'').replace(/'/g,'').replace(/-/g,' ');
        out = out.replace(/\s+/g,' ').trim();
        return out;
      };

      const benzene = (cx=160,cy=90,r=38)=>{
        let pts=[];
        for(let i=0;i<6;i++){const a=Math.PI/3*i-Math.PI/6;pts.push([cx+r*Math.cos(a),cy+r*Math.sin(a)])}
        return `<svg viewBox="0 0 360 180" xmlns="http://www.w3.org/2000/svg"><polygon points="${pts.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#111" stroke-width="2" vector-effect="non-scaling-stroke"/><circle cx="${cx}" cy="${cy}" r="${r-12}" fill="none" stroke="#111" stroke-width="2" vector-effect="non-scaling-stroke"/></svg>`;
      };

      const S = (w=360,h=180)=>`<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">`;
      const E = `</svg>`;

      const G = [
        {k:'alcool', l:'Alcool', a:['alcool','alcohol'], d:()=> S(360,180)+`<image href="./gf_imgs/alcool.png" xlink:href="./gf_imgs/alcool.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'phenol', l:'Phénol', a:['phénol','phenol'], d:()=> S(360,180)+`<image href="./gf_imgs/phenol.png" xlink:href="./gf_imgs/phenol.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'ether', l:'Éther', a:['ether','éther'], d:()=> S(360,180)+`<image href="./gf_imgs/ether.png" xlink:href="./gf_imgs/ether.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'aldehyde', l:'Aldéhyde', a:['aldehyde','aldéhyde'], d:()=> S(360,180)+`<image href="./gf_imgs/aldehyde.png" xlink:href="./gf_imgs/aldehyde.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'ketone', l:'Cétone', a:['cétone','cetone','ketone'], d:()=> S(360,180)+`<image href="./gf_imgs/ketone.png" xlink:href="./gf_imgs/ketone.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'carboxylique', l:'Acide carboxylique', a:['acide carboxylique','carboxylique','carboxylic acid'], d:()=> S(360,180)+`<image href="./gf_imgs/carboxylique.png" xlink:href="./gf_imgs/carboxylique.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'ester', l:'Ester', a:['ester'], d:()=> S(360,180)+`<image href="./gf_imgs/ester.png" xlink:href="./gf_imgs/ester.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'amide', l:'Amide', a:['amide'], d:()=> S(360,180)+`<image href="./gf_imgs/amide.png" xlink:href="./gf_imgs/amide.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'anhydride', l:"Anhydride d'acide", a:['anhydride',"anhydride d'acide",'acid anhydride'], d:()=> S(360,180)+`<image href="./gf_imgs/anhydride.png" xlink:href="./gf_imgs/anhydride.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'acylhalide', l:"Halogénure d'acyle", a:["halogénure d'acyle",'acyl halide','acyl chloride',"chlorure d'acyle"], d:()=> S(360,180)+`<image href="./gf_imgs/acylhalide.png" xlink:href="./gf_imgs/acylhalide.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'amine', l:'Amine', a:['amine','amino'], d:()=> S(360,180)+`<image href="./gf_imgs/amine.png" xlink:href="./gf_imgs/amine.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'nitrile', l:'Nitrile', a:['nitrile','cyano'], d:()=> S(360,180)+`<image href="./gf_imgs/nitrile.png" xlink:href="./gf_imgs/nitrile.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'haloalkane', l:'Halogénoalcane', a:["halogénoalcane","halogénure d'alkyle",'alkyl halide','haloalcane','halogene'], d:()=> S(360,180)+`<image href="./gf_imgs/haloalkane.png" xlink:href="./gf_imgs/haloalkane.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'nitro', l:'Nitro', a:['nitro','groupe nitro'], d:()=> S(360,180)+`<image href="./gf_imgs/nitro.png" xlink:href="./gf_imgs/nitro.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'thiol', l:'Thiol', a:['thiol','mercaptan'], d:()=> S(360,180)+`<image href="./gf_imgs/thiol.png" xlink:href="./gf_imgs/thiol.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'alkene', l:'Alcène', a:['alcene','alcène','alkene'], d:()=> S(360,180)+`<image href="./gf_imgs/alkene.png" xlink:href="./gf_imgs/alkene.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'alkyne', l:'Alcyne', a:['alcyne','alkyne'], d:()=> S(360,180)+`<image href="./gf_imgs/alkyne.png" xlink:href="./gf_imgs/alkyne.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
        {k:'aromatic', l:'Aromatique (arène)', a:['aromatique','arène','arene','benzene','benzène'], d:()=> S(360,180)+`<image href="./gf_imgs/aromatic.png" xlink:href="./gf_imgs/aromatic.png" x="0" y="0" width="360" height="180" preserveAspectRatio="xMidYMid meet" />`+E},
      ];

      const MNEMS = {
        alcool:["OH → « Oh l’alcool »","suffixe -ol","R–OH = simple bâton + bulle"],
        phenol:["Ar–OH = arène + OH","pHénol → pH (acide faible)","OH collé au cycle"],
        ether:["Éther = « entre » deux R","R–O–R’ comme un pont","Pas d’H sur O"],
        aldehyde:["C=O en bout → H terminal","« aldeHYDE » → H à côté","Odeur d’aldéhyde = extrémité"],
        ketone:["C=O au milieu","« céTone » → T = au cenTre","deux R autour du C=O"],
        carboxylique:["COOH = « cook »","double + OH = acide","C=O + O–H collés"],
        ester:["COOR’ = acide + alcool","odeur fruits = ester","O–C=O en sandwich"],
        amide:["CONH = amide","amide = acide + amine","C=O voisin de N"],
        anhydride:["(CO)–O–(CO) = deux acides","anhydre = sans eau formée","symétrie d’acide–O–acide"],
        acylhalide:["CO–X (X=Cl…)","réactif = X part facile","X remplace le OH acide"],
        amine:["N = trio branche","odeur poisson = amine","suffixe -amine"],
        nitrile:["C≡N = cyano","ligne triple = pointue","CN = cyanure"],
        haloalkane:["R–X (F/Cl/Br/I)","X = halogène sur chaîne","réaction SN/E facile"],
        nitro:["NO2 (N+ O- O)","explosif = nitro","N relié à deux O"],
        thiol:["–SH = soufre","odeur ail = thiol","analogue de l’alcool"],
        alkene:["C=C → double","suffixe -ène","π-liaison = plat"],
        alkyne:["C≡C → triple","suffixe -yne","ligne bien droite"],
        aromatic:["cycle benzène","Ar = arène","6 π délocalisés"]
      };

      // --- Quiz state ---
      function shuffleArr(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
      let order = shuffleArr([...G.keys()]);
      let idx = 0, score = 0, finished = false;
      const correctSet = new Set();

      const $ = (id)=>document.getElementById(id);
      const imgHrefOf = (g)=> (g.d().match(/href="([^"]+)"/)||[])[1];
      const prefetchNext = (n=3)=>{for(let i=1;i<=n;i++){const j=order[(idx+i)%order.length];const src=imgHrefOf(G[j]); if(!src) continue; const im=new Image(); im.src=src;}};
      const toast=(t)=>{const el=$('toast');el.textContent=t;el.style.display='block';setTimeout(()=>el.style.display='none',2000);};

      const DURATIONS=[5,8,12,Infinity];
      let timePerCard = 8;
      let timeLeft = timePerCard, tId=null;

      const BEST_KEY='gf_best_v1';
      const getBest=()=> Number(localStorage.getItem(BEST_KEY)||0);
      const setBest=(n)=> localStorage.setItem(BEST_KEY, String(Math.max(getBest(), n)));
      const updateBestHome=()=>{const el=$('best-pill'); if(el) el.textContent=`Meilleur : ${getBest()}/${G.length}`;};

      const setTimeBtnLabel=()=>{
        const label = (timePerCard===Infinity)?'∞':`${timePerCard}s`;
        $('time-btn').textContent = `Temps/carte : ${label}`;
        $('timer').textContent = (timePerCard===Infinity)?'∞':`00:${String(timePerCard).padStart(2,'0')}`;
      };
      $('time-btn').onclick=()=>{
        const i = (DURATIONS.indexOf(timePerCard)+1)%DURATIONS.length;
        timePerCard = DURATIONS[i];
        setTimeBtnLabel();
        resetTimer();
      };

      const resetTimer=()=>{
        clearInterval(tId);
        if(timePerCard===Infinity){ $('timer').textContent='∞'; return; }
        timeLeft = timePerCard;
        $('timer').textContent = `00:${String(timeLeft).padStart(2,'0')}`;
        tId = setInterval(()=>{
          timeLeft--;
          $('timer').textContent = `00:${String(Math.max(0,timeLeft)).padStart(2,'0')}`;
          if(timeLeft<=0){ clearInterval(tId); nextCard(); }
        },1000);
      };

      function render(){
        const g = G[order[idx]];
        $('svg').innerHTML = g.d();
        $('svgwrap').setAttribute('role','img');
        $('svgwrap').setAttribute('aria-label','Dessin du groupement en cours');
        $('prog').textContent = `${idx+1}/${G.length}`;
        $('score').textContent = `Score : ${score}`;
        $('msg').innerHTML = '';
        $('accepted').innerHTML = '';
        $('input').value = '';
        $('input').disabled = false;
        ['check','reveal','next','hint','time-btn'].forEach(id=>$(id).disabled=false);
        $('finish-actions').hidden = true;
        $('input').focus();
        prefetchNext(3);
        setTimeBtnLabel();
        resetTimer();
      }

      function finish(){
        finished = true;
        clearInterval(tId);
        $('msg').className='msg';
        $('msg').textContent = `Session terminée — Score : ${score}/${G.length}`;
        $('live').textContent = $('msg').textContent;
        $('accepted').innerHTML = '';
        $('input').disabled = true;
        ['check','reveal','next','hint'].forEach(id=>$(id).disabled=true);
        $('finish-actions').hidden = false;
        setBest(score);
        updateBestHome();
      }

      function nextCard(){
        if (finished) return;
        if (idx >= G.length-1){ finish(); return; }
        idx++;
        render();
      }

      const lev=(a,b)=>{a=[...norm(a)],b=[...norm(b)];const m=a.length,n=b.length;const d=Array.from({length:m+1},(_,i)=>Array(n+1).fill(0));for(let i=0;i<=m;i++)d[i][0]=i;for(let j=0;j<=n;j++)d[0][j]=j;for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c)}return d[m][n];};

      function checkAns(){
        if (finished) return;
        const g = G[order[idx]];
        const a = norm($('input').value);
        const base = [g.l, ...g.a].map(norm);
        const ok = base.includes(a) || base.some(x=>lev(a,x)<=2);
        $('msg').className = 'msg ' + (ok? 'ok':'bad');
        $('msg').textContent = ok ? 'Correct.' : 'Incorrect.';
        $('live').textContent = $('msg').textContent;

        if(ok && !correctSet.has(g.k)){
          correctSet.add(g.k);
          score++;
          $('score').textContent = `Score : ${score}`;
          setTimeout(nextCard, 350);
          $('accepted').innerHTML = '';
        } else if(!ok){
          const syn = `<span class="hint">Réponse attendue : <span class="answer">${g.l}</span>. Synonymes : ${g.a.join(', ')}</span>`;
          let extra = '';
          if(timePerCard===Infinity){
            const arr = MNEMS[g.k]||[];
            if(arr.length){ extra = `<br><span class="hint">Mnémotechnique : ${arr[Math.floor(Math.random()*arr.length)]}</span>`; }
          }
          $('accepted').innerHTML = syn + extra;
        }
      }

      function reveal(){
        if (finished) return;
        const g = G[order[idx]];
        $('msg').className = 'msg bad';
        $('msg').textContent = 'Révélé.';
        $('accepted').innerHTML = `<span class="hint">Réponse attendue : <span class="answer">${g.l}</span>. Synonymes : ${g.a.join(', ')}</span>`;
        $('live').textContent = $('msg').textContent;
      }

      function showHint(){
        if (finished) return;
        const g = G[order[idx]];
        const first = (norm(g.l)[0]||'?').toUpperCase();
        $('msg').className = 'msg';
        $('msg').textContent = `Indice : ${first}`;
        $('live').textContent = $('msg').textContent;
      }

      $('check').addEventListener('click', checkAns);
      $('reveal').addEventListener('click', reveal);
      $('next').addEventListener('click', nextCard);
      $('shuffle').addEventListener('click', ()=>{
        order = shuffleArr([...G.keys()]);
        idx = 0; score = 0; finished = false; correctSet.clear();
        render();
      });
      $('hint').addEventListener('click', showHint);
      $('input').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ checkAns(); }});

      $('restart').addEventListener('click', ()=>{
        order = shuffleArr([...G.keys()]);
        idx = 0; score = 0; finished = false; correctSet.clear();
        render();
      });

      const home = $('home');
      const chimie = $('chimie');
      const fgHub = $('fg-hub');
      const gf = $('gf');
      const builder = $('builder');
      const match = $('match');
      const crumbs = $('breadcrumbs');
      $('open-chimie').addEventListener('click', ()=>{ home.hidden=true; chimie.hidden=false; crumbs.textContent='Chimie organique'; });
      $('back-home-chimie').addEventListener('click', ()=>{ chimie.hidden=true; home.hidden=false; crumbs.textContent='Accueil'; });
      $('open-pratique').addEventListener('click', ()=>{ chimie.hidden=true; fgHub.hidden=false; crumbs.textContent='Pratique des groupes fonctionnels'; updateBestHome(); });
      $('back-chimie').addEventListener('click', ()=>{ fgHub.hidden=true; chimie.hidden=false; crumbs.textContent='Chimie organique'; });
      $('open-gf').addEventListener('click', ()=>{ fgHub.hidden=true; gf.hidden=false; crumbs.textContent='Flashcards GF'; render(); });
      $('back-home').addEventListener('click', ()=>{ gf.hidden=true; fgHub.hidden=false; crumbs.textContent='Pratique des groupes fonctionnels'; clearInterval(tId); updateBestHome(); });
      $('open-inverse').addEventListener('click', ()=>{
        fgHub.hidden=true;
        builder.hidden=false;
        crumbs.textContent='Mode inverse';
        invOrder = shuffleArr([...G.keys()]);
        invIdx = 0;
        invCorrect = 0;
        builderFinished = false;
        updateScore();
        startInverse();
      });
          $('back-home-builder').addEventListener('click', ()=>{ builder.hidden=true; fgHub.hidden=false; crumbs.textContent='Pratique des groupes fonctionnels'; });
      $('open-match').addEventListener('click', ()=>{ fgHub.hidden=true; match.hidden=false; crumbs.textContent='Match GF'; startMatch(); });
      $('back-match').addEventListener('click', ()=>{ match.hidden=true; fgHub.hidden=false; crumbs.textContent='Pratique des groupes fonctionnels'; clearInterval(matchTimerId); });
      $('gf-help').addEventListener('click', ()=>{
        alert('Tape le nom du groupe.\nUtilise Mélanger, Indice ou Révéler selon le besoin.');
      });
      $('builder-help').addEventListener('click', ()=>{
        alert('Glisse les atomes depuis la palette et choisis une liaison.\nTout effacer permet de recommencer, Voir la solution affiche la réponse.');
      });
      $('match-help').addEventListener('click', ()=>{
        alert('Clique un élément à gauche puis un à droite pour créer un lien.\nReclique sur une extrémité pour le supprimer.\nVérifie ou demande un indice si besoin.');
      });

      const workspace = $('workspace');
      const trash = $('trash');
      let bondSvg = $('bonds');
      let currentTarget;
      let invCorrect = 0;
      let invOrder = shuffleArr([...G.keys()]);
      let invIdx = 0;
      let builderFinished = false;
      const selectedAtoms = [];   
      const bonds = [];
           function resizeBondSvg(){
        const rect = workspace.getBoundingClientRect();
        bondSvg.setAttribute('width', rect.width);
        bondSvg.setAttribute('height', rect.height);
        bondSvg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
      }


      function updateScore(){ $('inv-score').textContent = `Score : ${invCorrect}`; }

      function startInverse(){
        if(builderFinished) return;
        currentTarget = G[invOrder[invIdx]];
        $('inv-target').textContent = currentTarget.l;
        $('inv-prog').textContent = `${invIdx+1}/${G.length}`;
        workspace.innerHTML = '<svg id="bonds" style="position:absolute;top:0;left:0;pointer-events:none"></svg>';
        bondSvg = $('bonds');
        resizeBondSvg();
        bonds.length = 0;
        workspace.style.pointerEvents = 'auto';
        $('palette').style.pointerEvents = 'auto';
      }

      document.querySelectorAll('#bond-tools button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
         if(selectedAtoms.length===2 && !hasBond(selectedAtoms[0], selectedAtoms[1])){
            drawBond(selectedAtoms[0], selectedAtoms[1], +btn.dataset.bond);
            updateLinks(selectedAtoms[0]);
            updateLinks(selectedAtoms[1]);
          }
          clearSelection();
        });
      });

      document.querySelectorAll('#palette .atom').forEach(a=>{
        a.addEventListener('pointerdown', e=>startDragFromPalette(a.dataset.atom, e));
      });
      $('clear-all').addEventListener('click', clearWorkspace);
      workspace.addEventListener('click', e=>{ if(!e.target.classList.contains('atom')) clearSelection(); });

      function clearWorkspace(){
        [...workspace.querySelectorAll('.atom')].forEach(removeAtom);
        bondSvg.innerHTML='';
        bonds.length=0;
        clearSelection();
      }
      function makeAtom(type){
        const el=document.createElement('div');
        el.className='atom';
        el.textContent=type;
        el.dataset.atom=type;
        el.style.position='absolute';
        el.links=[];
        el.addEventListener('pointerdown', ev=>dragAtom(el, ev));
        return el;
      }

      function startDragFromPalette(type, e){
        const el = makeAtom(type);
        workspace.appendChild(el);
        const rect = workspace.getBoundingClientRect();
        el.style.left=(e.clientX-rect.left-24)+"px";
        el.style.top=(e.clientY-rect.top-24)+"px";
        dragAtom(el, e);
      }
            function isOverTrash(el){
        const tr = trash.getBoundingClientRect();
        const er = el.getBoundingClientRect();
        return !(er.right < tr.left || er.left > tr.right || er.bottom < tr.top || er.top > tr.bottom);
      }

      function removeAtom(el){
        [...el.links].forEach(bnd=>{
          bnd.lines.forEach(line=>line.remove());
          const other = bnd.a===el ? bnd.b : bnd.a;
          other.links = other.links.filter(l=>l!==bnd);
          bonds.splice(bonds.indexOf(bnd),1);
        });
                const idx=selectedAtoms.indexOf(el);
        if(idx>-1){
          selectedAtoms.splice(idx,1);
          el.classList.remove('selected');
        }
        el.remove();
      }


      function dragAtom(el, e){
        const rect = workspace.getBoundingClientRect();
                const startX=e.clientX, startY=e.clientY;
        let dragging=false;
        function move(x,y){ el.style.left=(x-rect.left-24)+"px"; el.style.top=(y-rect.top-24)+"px"; updateLinks(el); trash.classList.toggle('over', isOverTrash(el)); }
        function onMove(ev){ if(!dragging && Math.hypot(ev.clientX-startX, ev.clientY-startY)>3) dragging=true; if(dragging) move(ev.clientX,ev.clientY); }
        function onUp(ev){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); trash.classList.remove('over'); if(!dragging){ toggleSelect(el); return; } if(isOverTrash(el)){ removeAtom(el); return; } finalizeAtom(el); }
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
        e.preventDefault();
      }
        function toggleSelect(atom){
        const idx=selectedAtoms.indexOf(atom);
        if(idx>-1){
          selectedAtoms.splice(idx,1);
          atom.classList.remove('selected');
        } else {
          if(selectedAtoms.length===2){
            selectedAtoms[0].classList.remove('selected');
            selectedAtoms.shift();
          }
          selectedAtoms.push(atom);
          atom.classList.add('selected');
        }
      }

      function clearSelection(){
        selectedAtoms.forEach(a=>a.classList.remove('selected'));
        selectedAtoms.length=0;
      }


      function hasBond(a,b){
        return bonds.some(bnd => (bnd.a===a && bnd.b===b) || (bnd.a===b && bnd.b===a));
      }

      function finalizeAtom(el){
        const atoms=[...workspace.querySelectorAll('.atom')].filter(x=>x!==el);
        let nearest=null, distMin=Infinity;
        const ex=parseFloat(el.style.left), ey=parseFloat(el.style.top);
        atoms.forEach(a=>{
          const ax=parseFloat(a.style.left), ay=parseFloat(a.style.top);
          const d=Math.hypot(ax-ex, ay-ey);
          if(d<distMin){distMin=d; nearest=a;}
        });
        if(nearest && distMin<80){
          const ax=parseFloat(nearest.style.left), ay=parseFloat(nearest.style.top);
          const dx=ex-ax, dy=ey-ay;
          const d=Math.hypot(dx,dy)||1;
          const nx=ax + dx/d*60;
          const ny=ay + dy/d*60;
          el.style.left=nx+'px';
          el.style.top=ny+'px';
        }
        updateLinks(el);
      }

      function drawBond(a,b,o){
        const bond={a,b,o,lines:[]};
        const x1=parseFloat(a.style.left)+24, y1=parseFloat(a.style.top)+24;
        const x2=parseFloat(b.style.left)+24, y2=parseFloat(b.style.top)+24;
        const len=Math.hypot(x2-x1,y2-y1)||1;
        for(let i=0;i<o;i++){
          const offset=(i-(o-1)/2)*4;
          const ox=-(y2-y1)/len*offset;
          const oy=(x2-x1)/len*offset;
          const line=document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', x1+ox);
          line.setAttribute('y1', y1+oy);
          line.setAttribute('x2', x2+ox);
          line.setAttribute('y2', y2+oy);
          line.setAttribute('stroke', '#000');
          line.setAttribute('stroke-width', 2);
          bondSvg.appendChild(line);
          bond.lines.push(line);
        }
        bonds.push(bond);
        a.links.push(bond);
        b.links.push(bond);
      }

      function updateLinks(atom){
        atom.links.forEach(bnd=>{
          const {a,b:other,o,lines}=bnd;
          const x1=parseFloat(a.style.left)+24, y1=parseFloat(a.style.top)+24;
          const x2=parseFloat(other.style.left)+24, y2=parseFloat(other.style.top)+24;
          const len=Math.hypot(x2-x1,y2-y1)||1;
          lines.forEach((line,i)=>{
            const offset=(i-(o-1)/2)*4;
            const ox=-(y2-y1)/len*offset;
            const oy=(x2-x1)/len*offset;
            line.setAttribute('x1', x1+ox);
            line.setAttribute('y1', y1+oy);
            line.setAttribute('x2', x2+ox);
            line.setAttribute('y2', y2+oy);
          });
        });
      }
        window.addEventListener('resize', ()=>{
        resizeBondSvg();
        [...workspace.querySelectorAll('.atom')].forEach(updateLinks);
      });


      $('show-answer').addEventListener('click', ()=>{
        const src = imgHrefOf(currentTarget);
        $('answer-box').innerHTML = src ? `<img src="${src}" alt="" style="display:block;max-width:200px;height:auto">` : benzene();
        $('answer-box').hidden = false;
        $('self-eval').hidden = false;
        $('show-answer').disabled = true;
      });

      $('self-right').addEventListener('click', ()=>{ invCorrect++; updateScore(); nextInverse(); });
      $('self-wrong').addEventListener('click', ()=>{ nextInverse(); });

      function nextInverse(){
        $('answer-box').hidden = true;
        $('self-eval').hidden = true;
        $('show-answer').disabled = false;
        invIdx++;
        if(invIdx >= G.length){
          finishInverse();
        } else {
          startInverse();
        }
      }

      function finishInverse(){
        builderFinished = true;
        workspace.style.pointerEvents = 'none';
        $('palette').style.pointerEvents = 'none';
        $('inv-msg').className = 'msg';
        $('inv-msg').textContent = `Session terminée — Score : ${invCorrect}/${G.length}`;
        $('inv-finish').hidden = false;
      }

      $('inv-restart').addEventListener('click', ()=>{
        invOrder = shuffleArr([...G.keys()]);
        invIdx = 0;
        invCorrect = 0;
        builderFinished = false;
        $('inv-msg').textContent='';
        $('inv-finish').hidden = true;
        updateScore();
        startInverse();
      });

            // --- Match mode ---
      const matchArea = $('match-area');
      const matchLeft = $('match-left');
      const matchRight = $('match-right');
      const matchLines = $('match-lines');
      let matchLinks = [];
      let matchSelected = null;
      let matchPairs = [];
      let matchTimerId;
      let matchStart = 0;
      const matchColors=['#ef4444','#f97316','#f59e0b','#eab308','#84cc16','#22c55e','#10b981','#14b8a6','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#8b5cf6','#a855f7','#d946ef','#ec4899','#f43f5e','#fb7185'];
      let matchColorIdx=0;
      function startMatch(){
        matchPairs = shuffleArr([...G]);
        const names = shuffleArr([...matchPairs]);
        matchLeft.innerHTML = '';
        matchRight.innerHTML = '';
        matchLines.innerHTML = '';
        matchLinks = [];
        matchSelected = null;
        matchColorIdx=0;
        matchPairs.forEach(g=>{
          const li=document.createElement('div');
          li.className='match-item';
          li.dataset.key=g.k;
          li.dataset.side='left';
          li.innerHTML=`<img src="${imgHrefOf(g)}" alt="">`;
          const dl=document.createElement('span');
          dl.className='match-dot';
          li.appendChild(dl);
          matchLeft.appendChild(li);
        });
        names.forEach(g=>{
          const ri=document.createElement('div');
          ri.className='match-item';
          ri.dataset.key=g.k;
          ri.dataset.side='right';
          ri.textContent=g.l;
          const dr=document.createElement('span');
          dr.className='match-dot';
          ri.appendChild(dr);
          matchRight.appendChild(ri);
        });
        [...matchArea.querySelectorAll('.match-item')].forEach(el=>el.addEventListener('click',()=>selectMatch(el)));
        matchStart=Date.now();
        $('match-timer').textContent='0s';
        clearInterval(matchTimerId);
        matchTimerId=setInterval(()=>{ $('match-timer').textContent=`${Math.floor((Date.now()-matchStart)/1000)}s`; },1000);
        $('match-msg').textContent='';
      }

      function selectMatch(el){
        if(el.dataset.linked){ removeLink(el); }
        if(matchSelected){
          if(matchSelected===el){ matchSelected.classList.remove('selected'); matchSelected=null; return; }
          connectMatch(matchSelected, el);
          matchSelected.classList.remove('selected');
          matchSelected=null;
        } else {
          el.classList.add('selected');
          matchSelected=el;
        }
      }

      function removeLink(el){
        const i=matchLinks.findIndex(l=>l.left===el || l.right===el);
        if(i>-1){
          const ln=matchLinks[i];
          ln.left.dataset.linked='';
          ln.right.dataset.linked='';
          ln.line.remove();
          matchLinks.splice(i,1);
        }
      }

      function connectMatch(a,b){
        const left=a.dataset.side==='left'?a:b;
        const right=a.dataset.side==='right'?a:b;
        removeLink(left);
        removeLink(right);
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        const color=matchColors[matchColorIdx%matchColors.length];
        matchColorIdx++;
        line.setAttribute('stroke',color);
        line.setAttribute('stroke-width',2);
        matchLines.appendChild(line);
        const link={left,right,key:left.dataset.key,line,color};
        matchLinks.push(link);
        left.dataset.linked='1';
        right.dataset.linked='1';
        updateMatchLine(link);
        left.classList.remove('selected');
        right.classList.remove('selected');
      }

      function updateMatchLine(link){
        const wrap=matchArea.getBoundingClientRect();
        const a=link.left.querySelector('.match-dot').getBoundingClientRect();
        const b=link.right.querySelector('.match-dot').getBoundingClientRect();
        const line=link.line;
        line.setAttribute('x1', a.left + a.width/2 - wrap.left);
        line.setAttribute('y1', a.top + a.height/2 - wrap.top);
        line.setAttribute('x2', b.left + b.width/2 - wrap.left);
        line.setAttribute('y2', b.top + b.height/2 - wrap.top);
      }
      window.addEventListener('resize', ()=>matchLinks.forEach(updateMatchLine));

      function verifyMatch(){
        let correct=0;
        matchLinks.forEach(l=>{
          updateMatchLine(l);
          if(l.left.dataset.key===l.right.dataset.key){
            l.line.setAttribute('stroke','#10b981');
            correct++;
          } else {
            l.line.setAttribute('stroke','#ef4444');
          }
        });
        $('match-msg').className='msg';
        $('match-msg').textContent=`Score : ${correct}/${matchPairs.length}`;
        if(correct===matchPairs.length){
          clearInterval(matchTimerId);
          const t=Math.floor((Date.now()-matchStart)/1000);
          const best=+localStorage.matchBest||Infinity;
          if(t<best) localStorage.matchBest=t;
          const bestMsg=isFinite(best)?Math.min(t,best):t;
          $('match-msg').textContent+=` — Temps : ${t}s (Meilleur : ${bestMsg}s)`;
        }
      }

      function hintMatch(){
        const remaining=matchPairs.filter(g=>!matchLinks.some(l=>l.key===g.k));
        if(!remaining.length) return;
        const g=remaining[Math.floor(Math.random()*remaining.length)];
        const l=[...matchLeft.children].find(e=>e.dataset.key===g.k);
        const r=[...matchRight.children].find(e=>e.dataset.key===g.k);
        l.classList.add('selected');
        r.classList.add('selected');
        setTimeout(()=>{l.classList.remove('selected');r.classList.remove('selected');},800);
      }

      $('match-check').addEventListener('click', verifyMatch);
      $('match-restart').addEventListener('click', startMatch);
      $('match-hint').addEventListener('click', hintMatch);

      document.addEventListener('keydown', (e)=>{
        if (e.target.id === 'input') { if (e.key === 'Enter') checkAns(); return; }
        const k=e.key.toLowerCase();
        if (k==='m') $('shuffle').click();
        if (k==='r') $('reveal').click();
        if (k==='n' || e.key==='ArrowRight') $('next').click();
      });

      $('svg').addEventListener('click', ()=>{
        const g=G[order[idx]];
        const src = imgHrefOf(g);
        $('zoomInner').innerHTML = src ? `<img src="${src}" alt="" style="display:block;max-width:100%;height:auto">` : benzene();
        $('zoom').style.display='flex';
      });
      $('zoom').addEventListener('click', (e)=>{ if (e.target.id==='zoom') $('zoom').style.display='none'; });

      window.addEventListener('error', ()=>toast('Erreur script — vérifie la dernière modif'));
      window.addEventListener('unhandledrejection', ()=>toast('Erreur promesse — check console'));

      // Meilleur score sur la Home
      updateBestHome();

      // Service worker (version bump pour invalider l’ancien cache)
      (function sw(){
        if ('serviceWorker' in navigator) {
          const swCode=`self.addEventListener('install',e=>{e.waitUntil(caches.open('etude-v3').then(c=>c.addAll(['./'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
          const blob=new Blob([swCode],{type:'text/javascript'});
          const url=URL.createObjectURL(blob);
          navigator.serviceWorker.register(url).catch(()=>{});
        }
      })();

      // Init UI
      setTimeBtnLabel();
    })();
  </script>
</body>
</html>
